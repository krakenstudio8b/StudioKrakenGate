<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-sCALE=1.0">
    <title>Gateradio - Dashboard Finanziaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .action-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        #edit-modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">Gateradio</h1>
            <p class="text-lg md:text-xl text-gray-600 mt-2">Dashboard Finanziaria Condivisa</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-2 space-y-6">
                <div class="card fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-2">
                        <h2 class="text-2xl font-semibold mb-2 sm:mb-0">Panoramica Grafica</h2>
                        <div class="flex items-center gap-2">
                            <label for="month-filter" class="text-sm font-medium">Visualizza:</label>
                            <select id="month-filter" class="p-2 border rounded-lg bg-gray-50">
                                <option value="all">Globale</option>
                                </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">Contributi Versati per Membro</h3>
                            <canvas id="membersContributionsChart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">Entrate Generate per Membro</h3>
                            <canvas id="membersIncomeChart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">Spese per Categoria</h3>
                            <canvas id="categoriesChart"></canvas>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">Saldo per Membro</h3>
                            <canvas id="balancesChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="cash-balance-section" class="card fade-in hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Cassa Comune</h2>
                    <div class="text-center">
                        <p class="text-lg text-gray-600">Saldo Disponibile</p>
                        <p id="cash-balance-amount" class="text-5xl font-bold text-green-600 my-2">€0.00</p>
                    </div>
                </div>

                <div id="summary-section" class="card fade-in hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                       <h2 class="text-2xl font-semibold">Riepilogo e Saldi</h2>
                       <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                           <button id="calculate-btn" class="w-full sm:w-auto bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors shadow">Calcola Saldi</button>
                           <button id="export-excel-btn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow">Esporta Excel</button>
                       </div>
                   </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Spese Fisse Mensili</p>
                            <p id="total-fixed-expense" class="text-2xl font-bold text-orange-600">€0.00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Spese Variabili Pagate</p>
                            <p id="total-variable-expense" class="text-2xl font-bold text-indigo-600">€0.00</p>
                        </div>
                         <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Entrate Totali</p>
                            <p id="total-income" class="text-2xl font-bold text-green-600">€0.00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-700">Quota Spese/Persona</p>
                            <p id="per-person-share" class="text-2xl font-bold text-red-600">€0.00</p>
                        </div>
                    </div>
                     <div id="settlement-container" class="mt-6 hidden">
                        <h3 class="text-xl font-semibold mb-3">Come Pareggiare i Conti</h3>
                        <div id="settlement-list" class="space-y-2"></div>
                    </div>
                </div>
                
                 <div id="pending-payments-section" class="card fade-in hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Quote da Versare</h2>
                    <div id="pending-payments-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                
                 <div id="future-movements-section" class="card fade-in hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Movimenti Futuri</h2>
                    <div id="future-movements-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="expenses-list-section" class="card fade-in hidden">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Elenco Spese Variabili</h2>
                        <div id="expenses-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                     <div id="income-list-section" class="card fade-in hidden">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Elenco Entrate</h2>
                        <div id="income-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                </div>
                 <div id="wishlist-section" class="card fade-in hidden">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Lista Desideri</h2>
                    <div id="wishlist-container" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card fade-in">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Gestione Dati e Membri (<span id="member-count">0</span>)</h2>
                    <div class="flex flex-wrap gap-2 mb-4" id="members-list"></div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="new-member-name" placeholder="Nome nuovo membro" class="flex-grow p-3 border rounded-lg">
                        <button id="add-member-btn" class="bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-600 shadow">Aggiungi</button>
                    </div>
                    <div class="mt-4 border-t pt-4">
                         <h3 class="text-lg font-medium mb-2">Backup e Trasferimento</h3>
                         <div class="flex flex-col sm:flex-row gap-3">
                            <button id="export-data-btn" class="flex-1 bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800">Esporta Dati</button>
                            <button id="import-data-btn" class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Importa Dati</button>
                         </div>
                         <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>

                <div id="quick-actions-section" class="card fade-in hidden">
                     <h2 class="text-xl font-semibold mb-4 border-b pb-2">Azioni Rapide</h2>
                     <div id="quick-actions-container" class="grid grid-cols-2 gap-3">
                        <button data-form-id="expense-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Aggiungi Spesa</button>
                        <button data-form-id="income-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Aggiungi Entrata</button>
                        <button data-form-id="cash-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Gestisci Cassa</button>
                        <button data-form-id="pending-payment-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Richiedi Quota</button>
                        <button data-form-id="future-movement-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Pianifica Spesa</button>
                        <button data-form-id="wishlist-form-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Aggiungi Desiderio</button>
                        <button data-form-id="fixed-expenses-section" class="action-btn text-sm font-semibold p-3 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors">Spese Fisse</button>
                     </div>
                </div>

                <div id="form-panels-container">
                    <div id="cash-form-section" class="card fade-in hidden action-form">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Gestisci Cassa Comune</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                             <div>
                                <label for="cash-movement-type" class="block text-sm font-medium">Tipo di Movimento</label>
                                <select id="cash-movement-type" class="w-full p-3 border rounded-lg">
                                    <option value="deposit">Deposito</option>
                                    <option value="withdrawal">Prelievo</option>
                                </select>
                            </div>
                            <div>
                                <label for="cash-movement-member" class="block text-sm font-medium">Membro (opzionale)</label>
                                <select id="cash-movement-member" class="w-full p-3 border rounded-lg">
                                    <option value="">Nessuno</option>
                                </select>
                            </div>
                            <div>
                                <label for="cash-movement-amount" class="block text-sm font-medium">Importo (€)</label>
                                <input type="number" id="cash-movement-amount" placeholder="50.00" class="w-full p-3 border rounded-lg">
                            </div>
                             <div>
                                <label for="cash-movement-description" class="block text-sm font-medium">Descrizione</label>
                                <input type="text" id="cash-movement-description" placeholder="Es. Versamento quota, prelievo per..." class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                        <button id="add-cash-movement-btn" class="mt-4 w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 shadow">Esegui Movimento</button>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-2">Storico Movimenti Cassa</h3>
                            <div id="cash-movements-history" class="space-y-2 max-h-60 overflow-y-auto pr-2 border-t pt-2"></div>
                        </div>
                    </div>
                    <div id="pending-payment-form-section" class="card fade-in hidden action-form">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Richiedi Quota da Versare</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="pending-payment-member" class="block text-sm font-medium">Membro</label>
                                <select id="pending-payment-member" class="w-full p-3 border rounded-lg"></select>
                            </div>
                            <div>
                                <label for="pending-payment-amount" class="block text-sm font-medium">Importo da Versare (€)</label>
                                <input type="number" id="pending-payment-amount" placeholder="200.00" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="pending-payment-description" class="block text-sm font-medium">Motivo</label>
                                <input type="text" id="pending-payment-description" placeholder="Es. Quota mensile" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                        <button id="add-pending-payment-btn" class="mt-4 w-full bg-yellow-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-yellow-600 shadow">Aggiungi Richiesta</button>
                    </div>
                    
                    <div id="future-movement-form-section" class="card fade-in hidden action-form">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-semibold">Aggiungi Movimento Futuro</h2>
                             <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="future-movement-description" class="block text-sm font-medium">Descrizione Spesa</label>
                                <input type="text" id="future-movement-description" placeholder="Es. Affitto mese prossimo" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="future-movement-cost" class="block text-sm font-medium">Costo Totale (€)</label>
                                <input type="number" id="future-movement-cost" placeholder="900.00" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="future-movement-due-date" class="block text-sm font-medium">Data Scadenza</label>
                                <input type="date" id="future-movement-due-date" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                        <button id="add-future-movement-btn" class="mt-4 w-full bg-cyan-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-600 shadow">Aggiungi Movimento</button>
                    </div>
                    
                    <div id="wishlist-form-section" class="card fade-in hidden action-form">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Aggiungi alla Lista Desideri</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="wishlist-item-name" class="block text-sm font-medium">Oggetto/Descrizione</label>
                                <input type="text" id="wishlist-item-name" placeholder="Es. Nuovo Mixer" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="wishlist-item-cost" class="block text-sm font-medium">Costo Stimato (€)</label>
                                <input type="number" id="wishlist-item-cost" placeholder="450.00" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="wishlist-item-priority" class="block text-sm font-medium">Priorità</label>
                                <select id="wishlist-item-priority" class="w-full p-3 border rounded-lg">
                                    <option value="3-Alta">Alta</option>
                                    <option value="2-Media" selected>Media</option>
                                    <option value="1-Bassa">Bassa</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium">Link di Acquisto</label>
                                <div class="flex gap-2">
                                    <input type="text" id="wishlist-new-link-input" placeholder="https://..." class="w-full p-2 border rounded-lg">
                                    <button id="add-wishlist-link-btn" type="button" class="bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-600 text-sm">Aggiungi</button>
                                </div>
                                <div id="wishlist-links-container" class="mt-2 space-y-1 text-sm"></div>
                            </div>
                        </div>
                        <button id="add-wishlist-item-btn" class="mt-4 w-full bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-600 shadow">Aggiungi Desiderio</button>
                    </div>

                    <div id="income-form-section" class="card fade-in hidden action-form">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Aggiungi Entrata</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="income-date" class="block text-sm font-medium text-gray-700 mb-1">Data Entrata</label>
                                <input type="date" id="income-date" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="income-amount" class="block text-sm font-medium text-gray-700 mb-1">Importo Guadagnato (€)</label>
                                <input type="number" id="income-amount" placeholder="300.00" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="income-description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione (es. Serata, Progetto...)</label>
                                <input type="text" id="income-description" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                 <label class="block text-sm font-medium text-gray-700 mb-1">Membri Coinvolti</label>
                                 <div id="income-members-checkboxes" class="p-3 border rounded-lg max-h-32 overflow-y-auto space-y-2"></div>
                            </div>
                        </div>
                        <button id="add-income-btn" class="mt-4 w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 shadow">Aggiungi Entrata</button>
                    </div>

                    <div id="expense-form-section" class="card fade-in hidden action-form">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Aggiungi Spesa</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="space-y-4">
                             <div>
                                <label for="payer" class="block text-sm font-medium text-gray-700 mb-1">Pagato da</label>
                                <select id="payer" class="w-full p-3 border rounded-lg"></select>
                            </div>
                             <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-1">Data Spesa</label>
                                <input type="date" id="expense-date" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Importo (€)</label>
                                <input type="number" id="amount" placeholder="50.00" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                <input type="text" id="category" list="category-list" placeholder="Es. Bollette" class="w-full p-3 border rounded-lg">
                                <datalist id="category-list">
                                    <option value="Affitto"></option>
                                    <option value="Bollette"></option>
                                    <option value="Attrezzatura"></option>
                                    <option value="Materiali"></option>
                                    <option value="Manutenzione"></option>
                                    <option value="Cibo e Bevande"></option>
                                    <option value="Altro"></option>
                                </datalist>
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                                <input type="text" id="description" placeholder="Breve descrizione della spesa" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                        <button id="add-expense-btn" class="mt-4 w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 shadow">Aggiungi Spesa</button>
                    </div>

                    <div id="fixed-expenses-section" class="card fade-in hidden action-form">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Gestione Spese Fisse</h2>
                            <button class="close-form-btn text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div id="fixed-expenses-list" class="space-y-2 mb-4"></div>
                        <div class="space-y-3">
                             <input type="text" id="fixed-desc" placeholder="Descrizione (es. Affitto)" class="w-full p-3 border rounded-lg">
                             <input type="number" id="fixed-amount" placeholder="Importo mensile" class="w-full p-3 border rounded-lg">
                             <button id="add-fixed-expense-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600">Aggiungi Spesa Fissa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="edit-modal-content" class="card w-full max-w-lg max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="edit-modal-title" class="text-2xl font-semibold">Modifica Elemento</h2>
                <button id="close-edit-modal-btn" class="text-3xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="edit-modal-form-container" class="space-y-4">
                </div>
            <div id="edit-modal-actions" class="mt-6 flex justify-end gap-3">
                </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBtQZkX6r4F2W0BsIo6nsD27dUZHv3e8RU",
          authDomain: "studio-kraken-gate.firebaseapp.com",
          projectId: "studio-kraken-gate",
          storageBucket: "studio-kraken-gate.firebasestorage.app",
          messagingSenderId: "744360512833",
          appId: "1:744360512833:web:ed0952f304c37bd5ee25c0",
          measurementId: "G-39RLC549LJ",
          databaseURL: "https://studio-kraken-gate-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Riferimenti ai nodi del tuo database
        const membersRef = ref(database, 'members');
        const varExpensesRef = ref(database, 'variableExpenses');
        const fixedExpensesRef = ref(database, 'fixedExpenses');
        const incomeRef = ref(database, 'incomeEntries');
        const wishlistRef = ref(database, 'wishlist');
        const futureMovementsRef = ref(database, 'futureMovements');
        const pendingPaymentsRef = ref(database, 'pendingPayments');
        const cassaComuneRef = ref(database, 'cassaComune');

        // --- Data State (Firebase-synced) ---
        let members = [];
        let variableExpenses = [];
        let fixedExpenses = [];
        let incomeEntries = [];
        let wishlist = [];
        let futureMovements = [];
        let pendingPayments = [];
        let cassaComune = { balance: 0, movements: [] };

        function saveDataToFirebase() {
            set(membersRef, members);
            set(varExpensesRef, variableExpenses);
            set(fixedExpensesRef, fixedExpenses);
            set(incomeRef, incomeEntries);
            set(wishlistRef, wishlist);
            set(futureMovementsRef, futureMovements);
            set(pendingPaymentsRef, pendingPayments);
            set(cassaComuneRef, cassaComune);
        }

        function loadDataFromFirebase() {
            onValue(membersRef, (snapshot) => {
                members = snapshot.val() || [];
                renderMembers();
                toggleSectionsVisibility();
                updatePayerSelects();
            });

            onValue(varExpensesRef, (snapshot) => {
                variableExpenses = snapshot.val() || [];
                renderVariableExpenses();
                updateDashboardView();
                populateMonthFilter();
            });

            onValue(fixedExpensesRef, (snapshot) => {
                fixedExpenses = snapshot.val() || [];
                renderFixedExpenses();
                updateDashboardView();
            });

            onValue(incomeRef, (snapshot) => {
                incomeEntries = snapshot.val() || [];
                renderIncomeEntries();
                updateDashboardView();
                populateMonthFilter();
            });

            onValue(wishlistRef, (snapshot) => {
                wishlist = snapshot.val() || [];
                renderWishlist();
            });

            onValue(futureMovementsRef, (snapshot) => {
                futureMovements = snapshot.val() || [];
                renderFutureMovements();
            });

            onValue(pendingPaymentsRef, (snapshot) => {
                pendingPayments = snapshot.val() || [];
                renderPendingPayments();
            });

            onValue(cassaComuneRef, (snapshot) => {
                cassaComune = snapshot.val() || { balance: 0, movements: [] };
                renderCassaComune();
            });
        }
        
        // --- App Logic ---
        const monthFilter = document.getElementById('month-filter');
        const memberCountEl = document.getElementById('member-count');
        const membersListEl = document.getElementById('members-list');
        const newMemberNameInput = document.getElementById('new-member-name');
        const addMemberBtn = document.getElementById('add-member-btn');
        const payerSelect = document.getElementById('payer');
        const expenseDateInput = document.getElementById('expense-date');
        const amountInput = document.getElementById('amount');
        const categoryInput = document.getElementById('category');
        const descriptionInput = document.getElementById('description');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const fixedDescInput = document.getElementById('fixed-desc');
        const fixedAmountInput = document.getElementById('fixed-amount');
        const addFixedExpenseBtn = document.getElementById('add-fixed-expense-btn');
        const fixedExpensesListEl = document.getElementById('fixed-expenses-list');
        const totalFixedEl = document.getElementById('total-fixed-expense');
        const totalVariableEl = document.getElementById('total-variable-expense');
        const totalIncomeEl = document.getElementById('total-income');
        const perPersonShareEl = document.getElementById('per-person-share');
        const expensesListContainer = document.getElementById('expenses-list-container');
        const calculateBtn = document.getElementById('calculate-btn');
        const settlementContainer = document.getElementById('settlement-container');
        const settlementList = document.getElementById('settlement-list');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportDataBtn = document.getElementById('export-data-btn');
        const importDataBtn = document.getElementById('import-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const incomeDateInput = document.getElementById('income-date');
        const incomeAmountInput = document.getElementById('income-amount');
        const incomeDescriptionInput = document.getElementById('income-description');
        const incomeMembersCheckboxes = document.getElementById('income-members-checkboxes');
        const addIncomeBtn = document.getElementById('add-income-btn');
        const incomeListContainer = document.getElementById('income-list-container');
        const wishlistItemNameInput = document.getElementById('wishlist-item-name');
        const wishlistItemCostInput = document.getElementById('wishlist-item-cost');
        const wishlistItemPriorityInput = document.getElementById('wishlist-item-priority');
        const addWishlistItemBtn = document.getElementById('add-wishlist-item-btn');
        const wishlistContainer = document.getElementById('wishlist-container');
        const wishlistNewLinkInput = document.getElementById('wishlist-new-link-input');
        const addWishlistLinkBtn = document.getElementById('add-wishlist-link-btn');
        const wishlistLinksContainer = document.getElementById('wishlist-links-container');
        const futureMovementDescriptionInput = document.getElementById('future-movement-description');
        const futureMovementCostInput = document.getElementById('future-movement-cost');
        const futureMovementDueDateInput = document.getElementById('future-movement-due-date');
        const addFutureMovementBtn = document.getElementById('add-future-movement-btn');
        const futureMovementsContainer = document.getElementById('future-movements-container');
        const pendingPaymentMemberSelect = document.getElementById('pending-payment-member');
        const pendingPaymentAmountInput = document.getElementById('pending-payment-amount');
        const pendingPaymentDescriptionInput = document.getElementById('pending-payment-description');
        const addPendingPaymentBtn = document.getElementById('add-pending-payment-btn');
        const pendingPaymentsContainer = document.getElementById('pending-payments-container');
        const quickActionsContainer = document.getElementById('quick-actions-container');
        const actionForms = document.querySelectorAll('.action-form');
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalFormContainer = document.getElementById('edit-modal-form-container');
        const editModalActions = document.getElementById('edit-modal-actions');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const cashBalanceAmountEl = document.getElementById('cash-balance-amount');
        const cashMovementTypeSelect = document.getElementById('cash-movement-type');
        const cashMovementMemberSelect = document.getElementById('cash-movement-member');
        const cashMovementAmountInput = document.getElementById('cash-movement-amount');
        const cashMovementDescriptionInput = document.getElementById('cash-movement-description');
        const addCashMovementBtn = document.getElementById('add-cash-movement-btn');
        const cashMovementsHistoryEl = document.getElementById('cash-movements-history');
        
        let tempWishlistLinks = [];
        let membersContributionsChart, membersIncomeChart, categoriesChart, balancesChart;

        const sections = {
            summary: document.getElementById('summary-section'),
            cashBalance: document.getElementById('cash-balance-section'),
            expensesList: document.getElementById('expenses-list-section'),
            incomeList: document.getElementById('income-list-section'),
            wishlist: document.getElementById('wishlist-section'),
            futureMovements: document.getElementById('future-movements-section'),
            pendingPayments: document.getElementById('pending-payments-section'),
            quickActions: document.getElementById('quick-actions-section'),
        };

        // --- Utility Functions ---
        const populateMonthFilter = () => {
            const months = new Set();
            [...variableExpenses, ...incomeEntries].forEach(item => {
                if (item.date) {
                    const date = new Date(item.date);
                    const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    months.add(month);
                }
            });

            const currentSelection = monthFilter.value;
            
            monthFilter.innerHTML = '<option value="all">Globale</option>';

            const sortedMonths = Array.from(months).sort().reverse();
            
            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                const optionText = date.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = month; 
                option.textContent = optionText.charAt(0).toUpperCase() + optionText.slice(1);
                monthFilter.appendChild(option);
            });

            if (Array.from(monthFilter.options).some(opt => opt.value === currentSelection)) {
                monthFilter.value = currentSelection;
            }
        };

        const toggleSectionsVisibility = () => {
            const hasMembers = members.length > 0;
            Object.values(sections).forEach(section => {
                section.classList.toggle('hidden', !hasMembers);
            });
        };
        
        const formatDate = (dateString) => {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        };
        
        const displayDate = (dateString) => {
             if (!dateString) return 'N/A';
             const date = new Date(dateString);
             const userTimezoneOffset = date.getTimezoneOffset() * 60000;
             return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // --- Rendering Functions ---
        const renderMembers = () => {
            membersListEl.innerHTML = '';
            payerSelect.innerHTML = '';
            pendingPaymentMemberSelect.innerHTML = '';
            incomeMembersCheckboxes.innerHTML = '';
            cashMovementMemberSelect.innerHTML = '<option value="">Nessuno</option>';
            memberCountEl.textContent = members.length;

            const cassaOption = document.createElement('option');
            cassaOption.value = "Cassa Comune";
            cassaOption.textContent = "Cassa Comune";
            payerSelect.appendChild(cassaOption);


            members.forEach((member, index) => {
                const tag = document.createElement('div');
                tag.className = 'flex items-center bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full';
                tag.innerHTML = `<span>${member}</span><button data-index="${index}" class="remove-member-btn ml-2 text-indigo-500 hover:text-indigo-800 font-bold">&times;</button>`;
                membersListEl.appendChild(tag);

                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                payerSelect.appendChild(option.cloneNode(true));
                pendingPaymentMemberSelect.appendChild(option.cloneNode(true));
                cashMovementMemberSelect.appendChild(option.cloneNode(true));

                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `<input id="income-member-${index}" type="checkbox" value="${member}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                       <label for="income-member-${index}" class="ml-2 block text-sm text-gray-900">${member}</label>`;
                incomeMembersCheckboxes.appendChild(checkboxDiv);
            });
        };

        const renderCassaComune = () => {
            cashBalanceAmountEl.textContent = `€${cassaComune.balance.toFixed(2)}`;
            cashMovementsHistoryEl.innerHTML = '';
            if(cassaComune.movements.length === 0){
                cashMovementsHistoryEl.innerHTML = '<p class="text-gray-500 text-sm">Nessun movimento registrato.</p>';
                return;
            }

            [...cassaComune.movements].reverse().forEach(mov => {
                const isDeposit = mov.type === 'deposit';
                const el = document.createElement('div');
                el.className = `text-sm p-2 rounded-lg flex justify-between items-center ${isDeposit ? 'bg-green-50' : 'bg-red-50'}`;
                el.innerHTML = `
                    <div>
                        <p class="font-medium">${mov.description}</p>
                        <p class="text-xs text-gray-500">${displayDate(mov.date)} ${mov.member ? `(${mov.member})` : ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                         <p class="font-bold ${isDeposit ? 'text-green-600' : 'text-red-600'}">
                            ${isDeposit ? '+' : '-'}€${mov.amount.toFixed(2)}
                         </p>
                         <button data-id="${mov.id}" class="remove-cash-movement-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                    </div>
                `;
            cashMovementsHistoryEl.appendChild(el);
        });
    };

    const renderPendingPayments = () => {
        pendingPaymentsContainer.innerHTML = '';
        if (pendingPayments.length === 0) {
            pendingPaymentsContainer.innerHTML = '<p class="text-gray-500">Nessuna quota da versare.</p>';
            return;
        }

        pendingPayments.sort((a,b) => b.dateAdded - a.dateAdded);

        pendingPayments.forEach(payment => {
            const paymentEl = document.createElement('div');
            paymentEl.className = 'fade-in flex justify-between items-center bg-yellow-50 p-3 rounded-lg border border-yellow-200';
            paymentEl.innerHTML = `
                <div>
                    <p class="font-semibold text-yellow-800">${payment.description}</p>
                    <p class="text-sm text-gray-600">
                        Da: <span class="font-medium">${payment.member}</span>
                        <span class="text-gray-400 mx-2">|</span>
                        Registrato il: ${displayDate(new Date(payment.dateAdded))}
                    </p>
                </div>
                <div class="text-right flex items-center gap-3 ml-2">
                     <p class="font-bold text-lg text-red-600">€${parseFloat(payment.amount).toFixed(2)}</p>
                     <div class="flex flex-col gap-1">
                        <button data-id="${payment.id}" class="confirm-pending-payment-btn text-xs bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600">Salda</button>
                        <div>
                            <button data-id="${payment.id}" data-type="pendingPayment" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                            <button data-id="${payment.id}" class="remove-pending-payment-btn text-red-500 hover:text-red-700 p-1 font-bold">&times;</button>
                        </div>
                     </div>
                </div>
            `;
            pendingPaymentsContainer.appendChild(paymentEl);
        });
    };
    
    const renderFutureMovements = () => {
        futureMovementsContainer.innerHTML = '';
         if (futureMovements.length === 0) {
            futureMovementsContainer.innerHTML = '<p class="text-gray-500">Nessun movimento futuro pianificato.</p>';
            return;
        }

        futureMovements.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        futureMovements.forEach(mov => {
            const movEl = document.createElement('div');
            movEl.className = 'fade-in bg-cyan-50 p-4 rounded-lg border border-cyan-200';
            const isExpanded = mov.isExpanded || false;
            
            const currentSharesSum = mov.shares.reduce((sum, s) => sum + s.amount, 0);
            const difference = mov.totalCost - currentSharesSum;
            const differenceColor = Math.abs(difference) < 0.01 ? 'text-green-600' : 'text-red-600';

            let sharesHtml = '';
            if (isExpanded) {
                sharesHtml = `<div class="mt-3 pt-3 border-t border-cyan-200 space-y-2">`;
                mov.shares.forEach(share => {
                    sharesHtml += `
                        <div class="flex items-center justify-between text-sm gap-2">
                            <label for="share-${mov.id}-${share.member}" class="font-medium">${share.member}</label>
                            <div class="flex items-center gap-1">
                                <input type="number" step="0.01" id="share-${mov.id}-${share.member}" 
                                    data-movement-id="${mov.id}" data-member-name="${share.member}"
                                    class="share-input w-24 p-1 border rounded-md text-right" value="${share.amount.toFixed(2)}">
                                ${share.edited ? `<button class="reset-share-btn text-xs text-blue-500" data-movement-id="${mov.id}" data-member-name="${share.member}">&#x21BA;</button>` : `<span class="w-4"></span>`}
                            </div>
                        </div>
                    `;
                });
                sharesHtml += `
                    <div class="flex justify-between items-center mt-3 pt-2 border-t text-sm">
                        <div>
                            <span class="font-bold">Totale Quote:</span>
                            <span class="font-mono ${differenceColor}">€${currentSharesSum.toFixed(2)}</span>
                            <span class="text-xs ${differenceColor}"> (${difference >= 0 ? '+' : ''}${difference.toFixed(2)})</span>
                        </div>
                        <button data-id="${mov.id}" class="recalculate-shares-btn text-xs bg-blue-500 text-white font-semibold py-1 px-2 rounded-md hover:bg-blue-600">Pareggia Quote</button>
                    </div>
                `;
                sharesHtml += `</div>`;
            }

            movEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold text-cyan-800">${mov.description}</p>
                        <p class="text-sm text-gray-600">
                            Scadenza: <span class="font-medium">${displayDate(mov.dueDate)}</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl text-cyan-600">€${mov.totalCost.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">€${(members.length > 0 ? mov.totalCost / members.length : 0).toFixed(2)} / persona</p>
                    </div>
                </div>
                ${sharesHtml}
                <div class="flex items-center gap-2 mt-4">
                    <button data-id="${mov.id}" class="confirm-payment-btn flex-1 text-sm bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Conferma Pagamento</button>
                    <button data-id="${mov.id}" class="manage-shares-btn flex-1 text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300">${isExpanded ? 'Chiudi Quote' : 'Gestisci Quote'}</button>
                    <div class="flex">
                        <button data-id="${mov.id}" data-type="futureMovement" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                        <button data-id="${mov.id}" class="remove-future-movement-btn text-red-500 hover:text-red-700 font-bold p-1">&times;</button>
                    </div>
                </div>
            `;
            futureMovementsContainer.appendChild(movEl);
        });
    };
    
    const renderWishlist = () => {
        wishlistContainer.innerHTML = '';
        if (wishlist.length === 0) {
            wishlistContainer.innerHTML = '<p class="text-gray-500">Nessun articolo nella lista desideri.</p>';
            return;
        }

        const priorityMap = {
            '3-Alta': { text: 'Alta', color: 'bg-red-100 text-red-800' },
            '2-Media': { text: 'Media', color: 'bg-yellow-100 text-yellow-800' },
            '1-Bassa': { text: 'Bassa', color: 'bg-green-100 text-green-800' }
        };

        wishlist.sort((a, b) => b.priority.localeCompare(a.priority));

        wishlist.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'fade-in flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
            const priorityInfo = priorityMap[item.priority];

            let linksHtml = (item.links || []).map((link, index) => {
                 try {
                    const url = new URL(link.startsWith('http') ? link : `https://${link}`);
                    return `<a href="${url.href}" target="_blank" class="text-indigo-500 hover:underline">[Link ${index+1}]</a>`;
                } catch (e) {
                    return `<span class="text-gray-400">[Link ${index+1} non valido]</span>`;
                }
            }).join('<span class="mx-1">,</span> ');

            itemEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold">${item.name}</p>
                     <p class="text-sm text-gray-600">
                        Costo: <span class="font-medium">€${parseFloat(item.cost).toFixed(2)}</span>
                        <span class="text-gray-400 mx-2">|</span>
                        Priorità: <span class="text-xs font-medium px-2 py-0.5 rounded-full ${priorityInfo.color}">${priorityInfo.text}</span>
                    </p>
                    <div class="text-xs mt-1">${linksHtml}</div>
                </div>
                <div class="flex items-center gap-2 ml-2">
                     <button data-id="${item.id}" class="mark-purchased-btn text-xs bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600">Acquistato</button>
                     <div>
                         <button data-id="${item.id}" data-type="wishlistItem" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                         <button data-id="${item.id}" class="remove-wishlist-item-btn text-red-500 hover:text-red-700 p-1 font-bold">&times;</button>
                     </div>
                </div>
            `;
            wishlistContainer.appendChild(itemEl);
        });
    };
    
    const renderIncomeEntries = () => {
        incomeListContainer.innerHTML = '';
        if (incomeEntries.length === 0) {
            incomeListContainer.innerHTML = '<p class="text-gray-500">Nessuna entrata registrata.</p>';
            return;
        }
        incomeEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
        incomeEntries.forEach(income => {
            const incomeEl = document.createElement('div');
            incomeEl.className = 'fade-in flex justify-between items-start bg-green-50 p-3 rounded-lg border border-green-200';
            incomeEl.innerHTML = `
                <div>
                    <p class="font-semibold">${income.description}</p>
                    <p class="text-sm text-gray-600">
                        Membri: <span class="font-medium text-teal-700">${income.membersInvolved.join(', ')}</span>
                        <span class="text-gray-400 mx-2">|</span>
                        ${displayDate(income.date)}
                    </p>
                </div>
                <div class="text-right flex-shrink-0 ml-4">
                     <p class="font-bold text-lg text-green-600">+€${parseFloat(income.amount).toFixed(2)}</p>
                     <div>
                        <button data-id="${income.id}" data-type="incomeEntry" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                        <button data-id="${income.id}" class="remove-income-btn text-red-500 hover:text-red-700 p-1 font-bold">&times;</button>
                     </div>
                </div>
            `;
            incomeListContainer.appendChild(incomeEl);
        });
    };

    const renderVariableExpenses = () => {
        expensesListContainer.innerHTML = '';
        if (variableExpenses.length === 0) {
            expensesListContainer.innerHTML = '<p class="text-gray-500">Nessuna spesa registrata.</p>';
            return;
        }
        variableExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
        variableExpenses.forEach(expense => {
            const isFromCash = expense.payer === 'Cassa Comune';
            const expenseEl = document.createElement('div');
            expenseEl.className = `fade-in flex justify-between items-center p-3 rounded-lg border ${isFromCash ? 'bg-blue-50' : 'bg-gray-50'}`;
            expenseEl.innerHTML = `
                <div>
                    <p class="font-semibold">${expense.description} <span class="text-xs font-normal text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">${expense.category}</span></p>
                    <p class="text-sm text-gray-600">
                        Pagato da: <span class="font-medium ${isFromCash ? 'text-blue-600' : 'text-indigo-600'}">${expense.payer}</span>
                        <span class="text-gray-400 mx-2">|</span>
                        ${displayDate(expense.date)}
                    </p>
                </div>
                <div class="text-right">
                     <p class="font-bold text-lg">€${parseFloat(expense.amount).toFixed(2)}</p>
                     <div>
                         <button data-id="${expense.id}" data-type="variableExpense" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                         <button data-id="${expense.id}" class="remove-expense-btn text-red-500 hover:text-red-700 p-1 font-bold">&times;</button>
                    </div>
                </div>
            `;
            expensesListContainer.appendChild(expenseEl);
        });
    };

    const renderFixedExpenses = () => {
        fixedExpensesListEl.innerHTML = '';
        if(fixedExpenses.length === 0) {
            fixedExpensesListEl.innerHTML = '<p class="text-gray-500 text-sm">Nessuna spesa fissa aggiunta.</p>';
        }
        fixedExpenses.forEach(expense => {
            const el = document.createElement('div');
            el.className = 'flex justify-between items-center bg-orange-50 p-2 rounded-lg text-sm';
            el.innerHTML = `
                <span>${expense.description}</span>
                <div class="flex items-center gap-2">
                    <span class="font-bold">€${parseFloat(expense.amount).toFixed(2)}</span>
                    <button data-id="${expense.id}" data-type="fixedExpense" class="edit-btn text-blue-500 hover:text-blue-700 p-1">&#9998;</button>
                    <button data-id="${expense.id}" class="remove-fixed-expense-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                </div>
            `;
            fixedExpensesListEl.appendChild(el);
        });
    }

    // --- Charting Functions ---
    const createBarChart = (canvasId, label) => new Chart(document.getElementById(canvasId).getContext('2d'), {
        type: 'bar', data: { labels: [], datasets: [{ label, data: [], backgroundColor: [] }] },
        options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
    });
    
   

    const initializeCharts = () => {
        membersContributionsChart = createBarChart('membersContributionsChart', 'Contributi Versati (€)');
        membersContributionsChart.data.datasets[0].backgroundColor = 'rgba(79, 70, 229, 0.8)';
        
        membersIncomeChart = createBarChart('membersIncomeChart', 'Entrate Generate (€)');
        membersIncomeChart.data.datasets[0].backgroundColor = 'rgba(13, 148, 136, 0.8)';

        categoriesChart = new Chart(document.getElementById('categoriesChart').getContext('2d'), {
            type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4f46e5', '#10b981', '#ef4444', '#f97316', '#3b82f6', '#eab308', '#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } }
        });

        balancesChart = createBarChart('balancesChart', 'Saldo per Membro (€)');
    };

    // --- Calculation Logic ---
    const getCalculationData = (selectedMonth = 'all') => {
        let filteredVarExpenses = variableExpenses;
        let filteredIncome = incomeEntries;
        let filteredCashMovements = cassaComune.movements;
        let applicableFixedExpenses = fixedExpenses;

        if (selectedMonth !== 'all') {
            filteredVarExpenses = variableExpenses.filter(exp => exp.date && exp.date.startsWith(selectedMonth));
            filteredIncome = incomeEntries.filter(inc => inc.date && inc.date.startsWith(selectedMonth));
            filteredCashMovements = cassaComune.movements.filter(mov => mov.date && mov.date.startsWith(selectedMonth));
        }
        
        const totalVar = filteredVarExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        const totalFix = applicableFixedExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        
        const totalExpenseForShare = totalVar + totalFix;

        const totalIncome = filteredIncome.reduce((sum, inc) => sum + parseFloat(inc.amount), 0);
        
        const perPersonShare = members.length > 0 ? totalExpenseForShare / members.length : 0;

        const memberContributions = members.map(member => {
            const paidExpenses = filteredVarExpenses
                .filter(exp => exp.payer === member)
                .reduce((sum, exp) => sum + exp.amount, 0);
            const deposits = filteredCashMovements
                .filter(mov => mov.type === 'deposit' && mov.member === member)
                .reduce((sum, mov) => sum + mov.amount, 0);
            return paidExpenses + deposits;
        });
        
        const memberIncomes = members.map(member => {
            return filteredIncome.reduce((sum, income) => {
                if (income.membersInvolved.includes(member)) {
                    return sum + (parseFloat(income.amount) / income.membersInvolved.length);
                }
                return sum;
            }, 0);
        });

        const expenseBalances = members.map((member, index) => ({
            name: member,
            balance: memberContributions[index] - perPersonShare
        }));
        
        const categoryTotals = filteredVarExpenses.reduce((acc, exp) => {
            const category = exp.category || 'Non categorizzato';
            acc[category] = (acc[category] || 0) + parseFloat(exp.amount);
            return acc;
        }, {});
        
        return { totalVar, totalFix, totalIncome, perPersonShare, memberContributions, memberIncomes, expenseBalances, categoryTotals };
    };
    
    const calculateAndRenderSettlement = (forExport = false) => {
        if (members.length === 0) return [];
        
        const selectedMonth = monthFilter.value;
        const { expenseBalances, totalVar, totalFix } = getCalculationData(selectedMonth);
        const totalExpense = totalVar + totalFix;

        let debtors = expenseBalances.filter(p => p.balance < 0).map(p => ({ ...p, balance: -p.balance }));
        let creditors = expenseBalances.filter(p => p.balance > 0);
        const transactions = [];

        debtors.sort((a,b) => b.balance - a.balance);
        creditors.sort((a,b) => b.balance - a.balance);

        let d_ptr = 0;
        let c_ptr = 0;

        while (d_ptr < debtors.length && c_ptr < creditors.length) {
            const amount = Math.min(debtors[d_ptr].balance, creditors[c_ptr].balance);
            if (amount > 0.01) {
                transactions.push({ from: debtors[d_ptr].name, to: creditors[c_ptr].name, amount });
                debtors[d_ptr].balance -= amount;
                creditors[c_ptr].balance -= amount;
            }
            if (debtors[d_ptr].balance < 0.01) d_ptr++;
            if (creditors[c_ptr].balance < 0.01) c_ptr++;
        }
        
        if (forExport) {
            return transactions;
        }

        settlementList.innerHTML = '';
        if (transactions.length === 0 && totalExpense > 0) {
            settlementList.innerHTML = '<p class="text-center text-green-600 font-semibold p-3 bg-green-50 rounded-lg">Tutti i conti sono in pari!</p>';
        } else if (transactions.length > 0) {
            transactions.forEach(({ from, to, amount }) => {
                const li = document.createElement('div');
                li.className = 'bg-blue-50 p-3 rounded-lg flex items-center gap-3 flex-wrap';
                li.innerHTML = `
                    <span class="font-bold text-red-600">${from}</span>
                    <span class="text-gray-500">→</span>
                    <span class="font-bold text-green-600">${to}</span>
                    <span class="ml-auto font-bold text-xl text-blue-800">€${amount.toFixed(2)}</span>
                `;
                settlementList.appendChild(li);
            });
        } else {
             settlementList.innerHTML = '<p class="text-center text-gray-500">Nessuna transazione necessaria.</p>';
        }
        settlementContainer.classList.remove('hidden');
    };

    // --- Data Import/Export ---
    const handleExportData = () => {
        const dataToExport = { members, variableExpenses, fixedExpenses, incomeEntries, wishlist, futureMovements, pendingPayments, cassaComune };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = 'gateradio_data.json';
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    };

    const handleImportData = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm("Sei sicuro? Questa azione sovrascriverà i dati esistenti.")) {
                    if (data.members) members = data.members;
                    if (data.variableExpenses) variableExpenses = data.variableExpenses;
                    if (data.fixedExpenses) fixedExpenses = data.fixedExpenses;
                    if (data.incomeEntries) incomeEntries = data.incomeEntries;
                    if (data.wishlist) {
                        wishlist = (data.wishlist || []).map(item => {
                            if (item.link && !item.links) {
                                item.links = [item.link];
                                delete item.link;
                            }
                            return item;
                        });
                    }
                    if (data.futureMovements) futureMovements = data.futureMovements;
                    if (data.pendingPayments) pendingPayments = data.pendingPayments;
                    if (data.cassaComune) cassaComune = data.cassaComune;
                    
                    saveDataToFirebase();
                    alert("Dati importati con successo!");
                }
            } catch (error) {
                alert("Errore durante la lettura del file. Assicurati che sia un file di backup valido.");
            } finally {
                importFileInput.value = '';
            }
        };
        reader.readAsText(file);
    };

    // --- Excel Export ---
    const exportToExcel = async () => {
        if (typeof ExcelJS === 'undefined') {
            alert('Libreria di esportazione non caricata.');
            return;
        }

        const workbook = new ExcelJS.Workbook();
        
        const dashboardSheet = workbook.addWorksheet('Dashboard Grafici');
        const chartIds = ['membersContributionsChart', 'membersIncomeChart', 'categoriesChart', 'balancesChart'];
        const chartImages = chartIds.map(id => {
            const canvas = document.getElementById(id);
            return workbook.addImage({
                base64: canvas.toDataURL('image/png'),
                extension: 'png',
            });
        });
        
        dashboardSheet.addImage(chartImages[0], { tl: { col: 0.5, row: 1 }, ext: { width: 500, height: 250 } });
        dashboardSheet.addImage(chartImages[1], { tl: { col: 9.5, row: 1 }, ext: { width: 500, height: 250 } });
        dashboardSheet.addImage(chartImages[2], { tl: { col: 0.5, row: 15 }, ext: { width: 500, height: 250 } });
        dashboardSheet.addImage(chartImages[3], { tl: { col: 9.5, row: 15 }, ext: { width: 500, height: 250 } });

        const selectedMonth = monthFilter.value;
        const calculationData = getCalculationData(selectedMonth);
        const settlementTransactions = calculateAndRenderSettlement(true);
        const titleSuffix = selectedMonth === 'all' ? '(Globale)' : `(${monthFilter.options[monthFilter.selectedIndex].text})`;

        const summarySheet = workbook.addWorksheet("Riepilogo");
        summarySheet.addRows([
            [`Riepilogo ${titleSuffix}`], [],
            ["Saldo Cassa Comune", cassaComune.balance], [],
            ["Spese Fisse Mensili Totali", calculationData.totalFix], 
            ["Spese Variabili Pagate", calculationData.totalVar], 
            ["Spesa Totale (Var+Fix)", calculationData.totalVar + calculationData.totalFix], 
            ["Quota Spese per Persona", calculationData.perPersonShare], [],
            ["Entrate Totali", calculationData.totalIncome], [],
            ["CONTRIBUTI TOTALI PER MEMBRO (Spese pagate + Depositi in cassa)"],
            ["Membro", "Contributo"],
            ...members.map((m, i) => [m, calculationData.memberContributions[i]]), [],
            ["SALDO INDIVIDUALE"],
            ["Membro", "Saldo"],
            ...calculationData.expenseBalances.map(b => [b.name, b.balance]), [],
            ["TRANSAZIONI PER PAREGGIARE I CONTI"],
            ["Da", "A", "Importo"],
            ...settlementTransactions.map(t => [t.from, t.to, t.amount])
        ]);
        
        const cashMovementsSheet = workbook.addWorksheet("Movimenti Cassa");
        cashMovementsSheet.columns = [ { header: 'Data', key: 'date' }, { header: 'Tipo', key: 'type' }, { header: 'Importo', key: 'amount' }, { header: 'Descrizione', key: 'description' }, { header: 'Membro', key: 'member' } ];
        cashMovementsSheet.addRows(cassaComune.movements.map(m => ({...m, date: displayDate(m.date) })));

        const pendingSheet = workbook.addWorksheet("Quote da Versare");
        pendingSheet.columns = [ { header: 'Membro', key: 'member' }, { header: 'Importo', key: 'amount' }, { header: 'Descrizione', key: 'description' }, { header: 'Data Richiesta', key: 'dateAdded' } ];
        pendingSheet.addRows(pendingPayments.map(p => ({...p, dateAdded: displayDate(new Date(p.dateAdded)) })));

        const varExpSheet = workbook.addWorksheet("Dettaglio Spese");
        varExpSheet.columns = [ { header: 'Data', key: 'date' }, { header: 'Pagato da', key: 'payer' }, { header: 'Importo', key: 'amount' }, { header: 'Categoria', key: 'category' }, { header: 'Descrizione', key: 'description' } ];
        varExpSheet.addRows(variableExpenses);

        const fixExpSheet = workbook.addWorksheet("Dettaglio Spese Fisse");
        fixExpSheet.columns = [ { header: 'Descrizione', key: 'description' }, { header: 'Importo', key: 'amount' } ];
        fixExpSheet.addRows(fixedExpenses);

        const incomeSheet = workbook.addWorksheet("Dettaglio Entrate");
        incomeSheet.columns = [ { header: 'Data', key: 'date' }, { header: 'Importo', key: 'amount' }, { header: 'Descrizione', key: 'description' }, { header: 'Membri', key: 'membersInvolved' } ];
        incomeSheet.addRows(incomeEntries.map(i => ({...i, membersInvolved: i.membersInvolved.join(', ')})));

        const wishlistSheet = workbook.addWorksheet("Lista Desideri");
        wishlistSheet.columns = [ { header: 'Oggetto', key: 'name' }, { header: 'Costo Stimato', key: 'cost' }, { header: 'Priorità', key: 'priority' }, { header: 'Link', key: 'links' } ];
        wishlistSheet.addRows(wishlist.map(i => ({...i, priority: i.priority.split('-')[1], links: (i.links || []).join(', ') })));
        
        const futureSheet = workbook.addWorksheet("Movimenti Futuri");
        futureSheet.columns = [ { header: 'Scadenza', key: 'dueDate' }, { header: 'Descrizione', key: 'description' }, { header: 'Costo Totale', key: 'totalCost' } ];
        futureSheet.addRows(futureMovements);

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Gateradio_Bilancio_${selectedMonth === 'all' ? 'Globale' : selectedMonth}.xlsx`;
        link.click();
        URL.revokeObjectURL(link.href);
    };

    const updateDashboardView = () => {
        const selectedMonth = monthFilter.value;
        const calculationData = getCalculationData(selectedMonth);

        totalVariableEl.textContent = `€${calculationData.totalVar.toFixed(2)}`;
        totalFixedEl.textContent = `€${calculationData.totalFix.toFixed(2)}`;
        totalIncomeEl.textContent = `€${calculationData.totalIncome.toFixed(2)}`;
        perPersonShareEl.textContent = `€${calculationData.perPersonShare.toFixed(2)}`;

        const { memberContributions, memberIncomes, expenseBalances, categoryTotals } = calculationData;
         const updateChartData = (chart, labels, data) => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        };

        updateChartData(membersContributionsChart, members, memberContributions);
        updateChartData(membersIncomeChart, members, memberIncomes);
        updateChartData(categoriesChart, Object.keys(categoryTotals), Object.values(categoryTotals));
        
        const balancesChartEl = document.getElementById('balancesChart');
        if (balancesChartEl) {
             balancesChartEl.parentElement.classList.remove('hidden');
             balancesChart.data.labels = members;
             balancesChart.data.datasets[0].data = expenseBalances.map(b => b.balance);
             balancesChart.data.datasets[0].backgroundColor = expenseBalances.map(b => b.balance < 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)');
             balancesChart.update();
        }
        
        settlementContainer.classList.add('hidden');
    };
    
    // --- Master Render Function ---
    const renderAll = () => {
        toggleSectionsVisibility();
        populateMonthFilter(); 
        renderMembers();
        renderCassaComune();
        renderVariableExpenses();
        renderFixedExpenses();
        renderIncomeEntries();
        renderWishlist();
        renderFutureMovements();
        renderPendingPayments();
        updateDashboardView();
    };
    
     // --- Edit Modal Logic ---
    const getItemFromStore = (type, id) => {
        let store;
        switch (type) {
            case 'variableExpense': store = variableExpenses; break;
            case 'fixedExpense': store = fixedExpenses; break;
            case 'incomeEntry': store = incomeEntries; break;
            case 'pendingPayment': store = pendingPayments; break;
            case 'wishlistItem': store = wishlist; break;
            case 'futureMovement': store = futureMovements; break;
            default: return null;
        }
        return store.find(i => i.id === id);
    }
    
    const openEditModal = (id, type) => {
        const item = getItemFromStore(type, id);
        if (!item) {
            console.error(`Item with id ${id} and type ${type} not found.`);
            return;
        }

        let formHtml = '';
        let title = 'Modifica Elemento';
        
        const createInput = (label, id, type, value, placeholder = '') => `<div><label for="${id}" class="block text-sm font-medium">${label}</label><input type="${type}" id="${id}" value="${value}" placeholder="${placeholder}" class="w-full p-2 border rounded-lg mt-1"></div>`;
        const createSelect = (label, id, options, selectedValue) => {
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `<div><label for="${id}" class="block text-sm font-medium">${label}</label><select id="${id}" class="w-full p-2 border rounded-lg mt-1">${optionsHtml}</select></div>`;
        }

        switch (type) {
            case 'variableExpense':
                title = 'Modifica Spesa';
                formHtml = 
                    createSelect('Pagato da', 'edit-payer', ['Cassa Comune', ...members], item.payer) +
                    createInput('Data Spesa', 'edit-expense-date', 'date', formatDate(item.date)) +
                    createInput('Importo (€)', 'edit-amount', 'number', item.amount) +
                    createInput('Categoria', 'edit-category', 'text', item.category, 'Es. Bollette') +
                    createInput('Descrizione', 'edit-description', 'text', item.description);
                break;
            case 'fixedExpense':
                title = 'Modifica Spesa Fissa';
                formHtml = 
                    createInput('Descrizione', 'edit-fixed-desc', 'text', item.description) +
                    createInput('Importo (€)', 'edit-fixed-amount', 'number', item.amount);
                break;
            case 'incomeEntry':
                title = 'Modifica Entrata';
                let membersCheckboxes = members.map((m, i) => `
                    <div class="flex items-center">
                        <input id="edit-income-member-${i}" type="checkbox" value="${m}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${item.membersInvolved.includes(m) ? 'checked' : ''}>
                        <label for="edit-income-member-${i}" class="ml-2 block text-sm text-gray-900">${m}</label>
                    </div>`).join('');
                formHtml = 
                    createInput('Data Entrata', 'edit-income-date', 'date', formatDate(item.date)) +
                    createInput('Importo (€)', 'edit-income-amount', 'number', item.amount) +
                    createInput('Descrizione', 'edit-income-description', 'text', item.description) +
                    `<div><label class="block text-sm font-medium text-gray-700 mb-1">Membri Coinvolti</label><div id="edit-income-members-checkboxes" class="p-3 border rounded-lg max-h-32 overflow-y-auto space-y-2">${membersCheckboxes}</div></div>`;
                break;
            case 'pendingPayment':
                 title = 'Modifica Quota da Versare';
                 formHtml =
                     createSelect('Membro', 'edit-pending-member', members, item.member) +
                     createInput('Importo (€)', 'edit-pending-amount', 'number', item.amount) +
                     createInput('Descrizione', 'edit-pending-description', 'text', item.description);
                 break;
            case 'wishlistItem':
                title = 'Modifica Desiderio';
                let linksHtml = (item.links || []).map((link, i) => `<div class="flex items-center gap-2" data-link-index="${i}"><input type="text" class="w-full p-1 border rounded-md" value="${link}"><button type="button" class="remove-edit-link-btn text-red-500">&times;</button></div>`).join('');
                formHtml = 
                    createInput('Oggetto/Descrizione', 'edit-wishlist-name', 'text', item.name) +
                    createInput('Costo Stimato (€)', 'edit-wishlist-cost', 'number', item.cost) +
                     createSelect('Priorità', 'edit-wishlist-priority', ['3-Alta', '2-Media', '1-Bassa'], item.priority) +
                    `<div><label class="block text-sm font-medium">Link</label><div id="edit-wishlist-links-container" class="space-y-2 mt-1">${linksHtml}</div><div class="flex gap-2 mt-2"><input type="text" id="add-edit-link-input" class="w-full p-1 border rounded-md" placeholder="Aggiungi nuovo link..."><button id="add-edit-link-btn" type="button" class="text-sm bg-blue-500 text-white px-2 rounded-md hover:bg-blue-600">+</button></div></div>`;
                break;
            case 'futureMovement':
                title = 'Modifica Movimento Futuro';
                formHtml =
                    createInput('Descrizione', 'edit-future-desc', 'text', item.description) +
                    createInput('Costo Totale (€)', 'edit-future-cost', 'number', item.totalCost) +
                    createInput('Data Scadenza', 'edit-future-due-date', 'date', formatDate(item.dueDate));
                break;
        }

        editModalTitle.textContent = title;
        editModalFormContainer.innerHTML = formHtml;
        editModalActions.innerHTML = `<button id="cancel-edit-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Annulla</button>
                                  <button id="save-changes-btn" data-id="${id}" data-type="${type}" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600">Salva Modifiche</button>`;

        editModal.classList.remove('hidden');
        editModal.classList.add('flex');
    };

    const closeEditModal = () => {
        editModal.classList.add('hidden');
        editModal.classList.remove('flex');
        editModalFormContainer.innerHTML = '';
        editModalActions.innerHTML = '';
    };

    // --- Event Listeners ---
    monthFilter.addEventListener('change', updateDashboardView);

    addMemberBtn.addEventListener('click', () => {
        const name = newMemberNameInput.value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            newMemberNameInput.value = '';
            saveDataToFirebase();
        }
    });
    
    addCashMovementBtn.addEventListener('click', () => {
        const type = cashMovementTypeSelect.value;
        const amount = parseFloat(cashMovementAmountInput.value);
        const description = cashMovementDescriptionInput.value.trim();
        const member = cashMovementMemberSelect.value;

        if(isNaN(amount) || amount <= 0 || !description){
            alert("Per favore, inserisci un importo e una descrizione validi.");
            return;
        }

        if(type === 'withdrawal' && amount > cassaComune.balance) {
            alert("Fondi insufficienti nella cassa comune per questo prelievo.");
            return;
        }
        
        if (type === 'deposit') {
            cassaComune.balance += amount;
        } else {
            cassaComune.balance -= amount;
        }

        cassaComune.movements.push({
            id: Date.now().toString(),
            date: new Date().toISOString().split('T')[0],
            type, amount, description, member
        });

        [cashMovementAmountInput, cashMovementDescriptionInput].forEach(i => i.value = '');
        saveDataToFirebase();
    });

    addPendingPaymentBtn.addEventListener('click', () => {
        const member = pendingPaymentMemberSelect.value;
        const amount = parseFloat(pendingPaymentAmountInput.value);
        const description = pendingPaymentDescriptionInput.value.trim();

        if(!member || isNaN(amount) || amount <= 0 || !description) {
            alert("Per favore, compila tutti i campi.");
            return;
        }

        pendingPayments.push({
            id: Date.now().toString(),
            member,
            amount,
            description,
            dateAdded: Date.now()
        });

        [pendingPaymentAmountInput, pendingPaymentDescriptionInput].forEach(i => i.value = '');
        saveDataToFirebase();
    });
    
    addFutureMovementBtn.addEventListener('click', () => {
        const description = futureMovementDescriptionInput.value.trim();
        const totalCost = parseFloat(futureMovementCostInput.value);
        const dueDate = futureMovementDueDateInput.value;

        if (!description || isNaN(totalCost) || totalCost <= 0 || !dueDate) {
            alert('Per favore, compila tutti i campi del movimento futuro.');
            return;
        }
        
        const share = members.length > 0 ? totalCost / members.length : 0;
        const shares = members.map(member => ({ member, amount: share, edited: false }));

        futureMovements.push({
            id: Date.now().toString(),
            description, totalCost, dueDate, shares
        });

        [futureMovementDescriptionInput, futureMovementCostInput, futureMovementDueDateInput].forEach(i => i.value = '');
        saveDataToFirebase();
    });

    addWishlistLinkBtn.addEventListener('click', () => {
        const link = wishlistNewLinkInput.value.trim();
        if (link) {
            tempWishlistLinks.push(link);
            wishlistNewLinkInput.value = '';
            renderTempWishlistLinks();
        }
    });
    
    wishlistLinksContainer.addEventListener('click', (e) => {
        if (e.target.matches('.remove-temp-link-btn')) {
            const index = parseInt(e.target.dataset.index);
            tempWishlistLinks.splice(index, 1);
            renderTempWishlistLinks();
        }
    });

    const renderTempWishlistLinks = () => {
         wishlistLinksContainer.innerHTML = tempWishlistLinks.map((link, index) => `
            <div class="flex items-center justify-between bg-gray-100 p-1 rounded-md">
                <a href="${link.startsWith('http') ? link : 'https://' + link}" target="_blank" class="truncate hover:underline">${link}</a>
                <button data-index="${index}" class="remove-temp-link-btn text-red-500 font-bold ml-2">&times;</button>
            </div>
        `).join('');
    }

    addWishlistItemBtn.addEventListener('click', () => {
        const name = wishlistItemNameInput.value.trim();
        const cost = parseFloat(wishlistItemCostInput.value);
        const priority = wishlistItemPriorityInput.value;

        if (!name || isNaN(cost) || cost <= 0) {
            alert('Per favor, inserisci un nome e un costo validi per l\'articolo.');
            return;
        }

        wishlist.push({ id: Date.now().toString(), name, cost, links: tempWishlistLinks, priority });
        [wishlistItemNameInput, wishlistItemCostInput].forEach(i => i.value = '');
        wishlistItemPriorityInput.value = '2-Media';
        tempWishlistLinks = [];
        renderTempWishlistLinks();
        saveDataToFirebase();
    });
    
    addIncomeBtn.addEventListener('click', () => {
        const date = incomeDateInput.value;
        const amount = parseFloat(incomeAmountInput.value);
        const description = incomeDescriptionInput.value.trim();
        const membersInvolved = Array.from(incomeMembersCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value);

        if (isNaN(amount) || amount <= 0 || !description || membersInvolved.length === 0) {
            alert('Per favore, compila tutti i campi dell\'entrata e seleziona almeno un membro.');
            return;
        }
        
        incomeEntries.push({
            id: Date.now().toString(),
            date: date || new Date().toISOString().split('T')[0],
            amount, description, membersInvolved
        });
        
        [incomeDateInput, incomeAmountInput, incomeDescriptionInput].forEach(i => i.value = '');
        incomeMembersCheckboxes.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        saveDataToFirebase();
    });

    addExpenseBtn.addEventListener('click', () => {
        const payer = payerSelect.value;
        const date = expenseDateInput.value;
        const amount = parseFloat(amountInput.value);
        const description = descriptionInput.value.trim();
        const category = categoryInput.value.trim();

        if (!payer || isNaN(amount) || amount <= 0 || !description || !category) {
            alert('Per favore, compila tutti i campi della spesa.');
            return;
        }
        
        if (payer === 'Cassa Comune' && amount > cassaComune.balance) {
            alert('Fondi insufficienti nella cassa comune per questa spesa.');
            return;
        }

        variableExpenses.push({
            id: Date.now().toString(),
            date: date || new Date().toISOString().split('T')[0],
            payer, amount, description, category
        });

        if (payer === 'Cassa Comune') {
            cassaComune.balance -= amount;
            cassaComune.movements.push({
                id: Date.now().toString(),
                date: date || new Date().toISOString().split('T')[0],
                type: 'withdrawal', amount, description: `Spesa: ${description}`, member: ''
            });
        }

        [expenseDateInput, amountInput, descriptionInput, categoryInput].forEach(i => i.value = '');
        saveDataToFirebase();
    });
    
    addFixedExpenseBtn.addEventListener('click', () => {
        const description = fixedDescInput.value.trim();
        const amount = parseFloat(fixedAmountInput.value);
        if (!description || isNaN(amount) || amount <= 0) {
            alert('Inserisci una descrizione e un importo validi per la spesa fissa.');
            return;
        }
        fixedExpenses.push({ id: Date.now().toString(), description, amount });
        fixedDescInput.value = '';
        fixedAmountInput.value = '';
        saveDataToFirebase();
    });
    
    quickActionsContainer.addEventListener('click', (e) => {
        const actionBtn = e.target.closest('.action-btn');
        if (!actionBtn) return;

        const formId = actionBtn.dataset.formId;
        const targetPanel = document.getElementById(formId);

        if (actionBtn.classList.contains('active')) {
            actionBtn.classList.remove('active');
            if (targetPanel) targetPanel.classList.add('hidden');
            return;
        }
        
        quickActionsContainer.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
        actionForms.forEach(panel => panel.classList.add('hidden'));

        if (targetPanel) {
            targetPanel.classList.remove('hidden');
            actionBtn.classList.add('active');
            targetPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });

    document.body.addEventListener('change', (e) => {
        if (e.target.matches('.share-input')) {
            const movementId = e.target.dataset.movementId;
            const memberName = e.target.dataset.memberName;
            const newAmount = parseFloat(e.target.value);

            const movement = futureMovements.find(m => m.id === movementId);
            if (!movement || isNaN(newAmount)) return;

            const editedMemberShare = movement.shares.find(s => s.member === memberName);
            editedMemberShare.amount = newAmount;
            editedMemberShare.edited = true;
            
            renderFutureMovements();
        }
    });

    document.body.addEventListener('click', (e) => {
        if (e.target.matches('.close-form-btn')) {
            const formPanel = e.target.closest('.action-form');
            if(formPanel) {
                formPanel.classList.add('hidden');
                quickActionsContainer.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
            }
        }
        
         if (e.target.matches('.edit-btn')) {
            openEditModal(e.target.dataset.id, e.target.dataset.type);
        }

         if (e.target.matches('.recalculate-shares-btn')) {
            const movementId = e.target.dataset.id;
            const movement = futureMovements.find(m => m.id === movementId);
            if (!movement) return;

            const editedShares = movement.shares.filter(s => s.edited);
            const uneditedShares = movement.shares.filter(s => !s.edited);

            const sumOfEdited = editedShares.reduce((sum, s) => sum + s.amount, 0);
            const remainingAmount = movement.totalCost - sumOfEdited;

            if (uneditedShares.length > 0) {
                const newShareAmount = remainingAmount / uneditedShares.length;
                uneditedShares.forEach(s => s.amount = newShareAmount);
            } else if (Math.abs(movement.totalCost - sumOfEdited) > 0.01) {
                alert('Tutte le quote sono state modificate manualmente, ma la somma non corrisponde al totale. Per favore, correggi i valori.');
            }
            saveDataToFirebase();
        }

        if (e.target.matches('.reset-share-btn')) {
            const movementId = e.target.dataset.movementId;
            const memberName = e.target.dataset.memberName;
            const movement = futureMovements.find(m => m.id === movementId);
            if (movement) {
                const shareToReset = movement.shares.find(s => s.member === memberName);
                if(shareToReset) shareToReset.edited = false;
                e.target.closest('.fade-in').querySelector('.recalculate-shares-btn').click();
            }
        }

        if (e.target.matches('.remove-member-btn')) {
            const index = parseInt(e.target.dataset.index);
            const memberName = members[index];
            if (confirm(`Sei sicuro di voler rimuovere ${memberName}? Verranno rimosse anche tutte le sue spese, entrate e pagamenti in sospeso.`)) {
                members.splice(index, 1);
                variableExpenses = variableExpenses.filter(exp => exp.payer !== memberName);
                incomeEntries.forEach(inc => {
                    inc.membersInvolved = inc.membersInvolved.filter(m => m !== memberName);
                });
                incomeEntries = incomeEntries.filter(inc => inc.membersInvolved.length > 0);
                pendingPayments = pendingPayments.filter(p => p.member !== memberName);
                cassaComune.movements = cassaComune.movements.filter(m => m.member !== memberName);
                saveDataToFirebase();
            }
        }
        if (e.target.matches('.remove-expense-btn')) {
             const expenseId = e.target.dataset.id;
            const expenseToRemove = variableExpenses.find(exp => exp.id === expenseId);
            if (expenseToRemove && expenseToRemove.payer === 'Cassa Comune') {
                if(confirm("Questa spesa è stata pagata dalla cassa comune. Vuoi rimborsare la cassa?")) {
                    cassaComune.balance += expenseToRemove.amount;
                }
            }
            variableExpenses = variableExpenses.filter(exp => exp.id !== expenseId);
            saveDataToFirebase();
        }
         if (e.target.matches('.remove-income-btn')) {
            incomeEntries = incomeEntries.filter(inc => inc.id !== e.target.dataset.id);
            saveDataToFirebase();
        }
        if (e.target.matches('.remove-fixed-expense-btn')) {
            fixedExpenses = fixedExpenses.filter(exp => exp.id !== e.target.dataset.id);
            saveDataToFirebase();
        }
        if (e.target.matches('.remove-wishlist-item-btn')) {
            wishlist = wishlist.filter(item => item.id !== e.target.dataset.id);
            saveDataToFirebase();
        }
         if (e.target.matches('.remove-pending-payment-btn')) {
            if(confirm("Sei sicuro di voler rimuovere questa richiesta di quota?")) {
               pendingPayments = pendingPayments.filter(p => p.id !== e.target.dataset.id);
               saveDataToFirebase();
            }
        }
        if (e.target.matches('.remove-cash-movement-btn')) {
            const movementId = e.target.dataset.id;
            const movementIndex = cassaComune.movements.findIndex(m => m.id === movementId);
            if (movementIndex > -1) {
                if (confirm("Sei sicuro di voler annullare questo movimento? L'azione è irreversibile e modificherà il saldo della cassa.")) {
                    const movement = cassaComune.movements[movementIndex];
                    if (movement.type === 'deposit') {
                        cassaComune.balance -= movement.amount;
                    } else {
                        cassaComune.balance += movement.amount;
                    }
                    cassaComune.movements.splice(movementIndex, 1);
                    saveDataToFirebase();
                }
            }
        }
        if (e.target.matches('.confirm-pending-payment-btn')) {
            const paymentId = e.target.dataset.id;
            const payment = pendingPayments.find(p => p.id === paymentId);
            if (payment) {
                const isForCash = confirm(`Il pagamento di ${payment.member} per €${payment.amount} è un versamento nella Cassa Comune?`);
                if (isForCash) {
                     cassaComune.balance += payment.amount;
                     cassaComune.movements.push({
                        id: Date.now().toString(),
                        date: new Date().toISOString().split('T')[0],
                        type: 'deposit', 
                        amount: payment.amount, 
                        description: `Versamento quota: ${payment.description}`, 
                        member: payment.member
                    });
                } else {
                    variableExpenses.push({
                        id: Date.now().toString(),
                        date: new Date().toISOString().split('T')[0],
                        payer: payment.member,
                        amount: payment.amount,
                        description: `[Pagamento Salato] ${payment.description}`,
                        category: "Saldo Personale"
                    });
                }
                pendingPayments = pendingPayments.filter(p => p.id !== paymentId);
                saveDataToFirebase();
                alert(`Pagamento di ${payment.member} per €${payment.amount} registrato!`);
            }
        }
        if (e.target.matches('.mark-purchased-btn')) {
            const itemId = e.target.dataset.id;
            const item = wishlist.find(i => i.id === itemId);
            if (item) {
                descriptionInput.value = item.name;
                amountInput.value = item.cost;
                categoryInput.value = "Attrezzatura";
                wishlist = wishlist.filter(i => i.id !== itemId);
                saveDataToFirebase();
                
                const expenseFormBtn = quickActionsContainer.querySelector('[data-form-id="expense-form-section"]');
                if (expenseFormBtn) expenseFormBtn.click();
                
                alert(`"${item.name}" spostato nelle spese. Seleziona chi ha pagato e conferma.`);
            }
        }
        if (e.target.matches('.manage-shares-btn')) {
            const movementId = e.target.dataset.id;
            const movement = futureMovements.find(m => m.id === movementId);
            if (movement) {
                movement.isExpanded = !movement.isExpanded;
                renderFutureMovements();
            }
        }
        if (e.target.matches('.remove-future-movement-btn')) {
            futureMovements = futureMovements.filter(m => m.id !== e.target.dataset.id);
            saveDataToFirebase();
        }
        if (e.target.matches('.confirm-payment-btn')) {
            const movementId = e.target.dataset.id;
            const movement = futureMovements.find(m => m.id === movementId);
            if (movement) {
                 if (movement.totalCost > cassaComune.balance) {
                    alert("Fondi insufficienti nella cassa comune per confermare questa spesa futura.");
                    return;
                }
                
                variableExpenses.push({
                    id: Date.now().toString(),
                    date: movement.dueDate,
                    payer: 'Cassa Comune',
                    amount: movement.totalCost,
                    description: movement.description,
                    category: "Spesa Pianificata"
                });
                
                cassaComune.balance -= movement.totalCost;
                cassaComune.movements.push({
                    id: Date.now().toString(),
                    date: movement.dueDate,
                    type: 'withdrawal', 
                    amount: movement.totalCost, 
                    description: `Spesa pianificata: ${movement.description}`, 
                    member: ''
                });
                
                futureMovements = futureMovements.filter(m => m.id !== movementId);
                saveDataToFirebase();
                alert("Pagamento confermato e spesa registrata a carico della cassa comune!");
            }
        }
    });
    
    editModal.addEventListener('click', (e) => {
        if (e.target.matches('#save-changes-btn')) {
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;
            const item = getItemFromStore(type, id);
            if (!item) return;

            switch (type) {
                case 'variableExpense':
                    const oldPayer = item.payer;
                    const oldAmount = item.amount;
                    
                    item.payer = document.getElementById('edit-payer').value;
                    item.date = document.getElementById('edit-expense-date').value;
                    item.amount = parseFloat(document.getElementById('edit-amount').value);
                    item.category = document.getElementById('edit-category').value;
                    item.description = document.getElementById('edit-description').value;

                    if (oldPayer === 'Cassa Comune' && item.payer !== 'Cassa Comune') {
                        cassaComune.balance += oldAmount;
                    } else if (oldPayer !== 'Cassa Comune' && item.payer === 'Cassa Comune') {
                        cassaComune.balance -= item.amount;
                    } else if (oldPayer === 'Cassa Comune' && item.payer === 'Cassa Comune') {
                        cassaComune.balance += (oldAmount - item.amount);
                    }
                    break;
                 case 'fixedExpense':
                    item.description = document.getElementById('edit-fixed-desc').value;
                    item.amount = parseFloat(document.getElementById('edit-fixed-amount').value);
                    break;
                case 'incomeEntry':
                    item.date = document.getElementById('edit-income-date').value;
                    item.amount = parseFloat(document.getElementById('edit-income-amount').value);
                    item.description = document.getElementById('edit-income-description').value;
                    item.membersInvolved = Array.from(document.querySelectorAll('#edit-income-members-checkboxes input:checked')).map(cb => cb.value);
                    break;
                case 'pendingPayment':
                    item.member = document.getElementById('edit-pending-member').value;
                    item.amount = parseFloat(document.getElementById('edit-pending-amount').value);
                    item.description = document.getElementById('edit-pending-description').value;
                    break;
                case 'wishlistItem':
                    item.name = document.getElementById('edit-wishlist-name').value;
                    item.cost = parseFloat(document.getElementById('edit-wishlist-cost').value);
                    item.priority = document.getElementById('edit-wishlist-priority').value;
                    item.links = Array.from(document.querySelectorAll('#edit-wishlist-links-container input')).map(input => input.value.trim()).filter(link => link);
                    break;
                case 'futureMovement':
                    const oldTotalCost = item.totalCost;
                    item.description = document.getElementById('edit-future-desc').value;
                    item.totalCost = parseFloat(document.getElementById('edit-future-cost').value);
                    item.dueDate = document.getElementById('edit-future-due-date').value;
                    if (item.totalCost !== oldTotalCost && confirm("Il costo totale è cambiato. Vuoi resettare le quote individuali per distribuirle equamente?")) {
                        const share = members.length > 0 ? item.totalCost / members.length : 0;
                        item.shares = members.map(member => ({ member, amount: share, edited: false }));
                    }
                    break;
            }
            closeEditModal();
            saveDataToFirebase();
        }
        
        if(e.target.matches('#add-edit-link-btn')){
            const container = document.getElementById('edit-wishlist-links-container');
            const input = document.getElementById('add-edit-link-input');
            if (input.value.trim()) {
                 const div = document.createElement('div');
                 div.className = 'flex items-center gap-2';
                 div.innerHTML = `<input type="text" class="w-full p-1 border rounded-md" value="${input.value.trim()}"><button type="button" class="remove-edit-link-btn text-red-500">&times;</button>`;
                 container.appendChild(div);
                 input.value = '';
            }
        }

        if(e.target.matches('.remove-edit-link-btn')){
            e.target.parentElement.remove();
        }

        if (e.target === editModal || e.target.matches('#close-edit-modal-btn') || e.target.matches('#cancel-edit-btn')) {
            closeEditModal();
        }
    });

    calculateBtn.addEventListener('click', () => calculateAndRenderSettlement(false));
    exportExcelBtn.addEventListener('click', exportToExcel);
    exportDataBtn.addEventListener('click', handleExportData);
    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', handleImportData);

    function initializeCharts() {
        const categories = {};
        const initialData = {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                    '#4B5563', '#9CA3AF', '#6B7280', '#E5E7EB', '#D1D5DB'
                ],
                hoverOffset: 4
            }]
        };

        const initialOptions = {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false,
                }
            }
        };
        categoriesChart = new Chart(document.getElementById('categoriesChart'), {
            type: 'pie',
            data: initialData,
            options: initialOptions
        });
        membersContributionsChart = new Chart(document.getElementById('membersContributionsChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Contributi Versati (€)', data: [], backgroundColor: 'rgba(79, 70, 229, 0.8)' }] }, options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } } });
        membersIncomeChart = new Chart(document.getElementById('membersIncomeChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Entrate Generate (€)', data: [], backgroundColor: 'rgba(13, 148, 136, 0.8)' }] }, options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } } });
        balancesChart = new Chart(document.getElementById('balancesChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Saldo per Membro (€)', data: [], backgroundColor: [] }] }, options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } } });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeCharts();
        loadDataFromFirebase();
    });
</script>
</body>
</html>

